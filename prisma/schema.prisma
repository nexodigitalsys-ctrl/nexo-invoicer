generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  name         String?
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships Membership[]
  
}

model Workspace {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String   @unique // ex: "superclim", "cliente-construcciones"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships   Membership[]
  empresaConfig EmpresaConfig?
  clientes      Cliente[]
  facturas      Factura[]
  presupuestos  Presupuesto[]
  servicios     Servicio[]
}

model Membership {
  id          Int    @id @default(autoincrement())
  userId      Int
  workspaceId Int
  role        String @default("owner")

  user      User      @relation(fields: [userId], references: [id])
  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

model Cliente {
  id          Int       @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  nombre      String
  nif         String // ðŸ‘ˆ obrigatÃ³rio para faturar
  email       String?
  telefono    String?
  direccion   String? // ðŸ‘ˆ NOVO CAMPO
  createdAt   DateTime  @default(now())

  presupuestos Presupuesto[]
  facturas     Factura[]
}

model Servicio {
  id          Int       @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  nombre      String
  descripcion String?
  precio      Float?
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now())

  lineasPresupuesto PresupuestoLinea[]
  lineasFactura     FacturaLinea[]
}

model Presupuesto {
  id          Int       @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  numero      String    
  clienteId   Int
  cliente     Cliente   @relation(fields: [clienteId], references: [id])

  fecha  DateTime @default(now())
  estado String   @default("borrador")

  // ðŸ”¹ ADICIONAR ESTES 3 SE AINDA NÃƒO EXISTEM:
  subtotal      Float @default(0)
  ivaPorcentaje Float @default(21)
  ivaImporte    Float @default(0)

  total Float   @default(0) // se jÃ¡ existir, deixa como estÃ¡
  notas String?

  lineas PresupuestoLinea[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  @@unique([workspaceId, numero])
}

model PresupuestoLinea {
  id            Int         @id @default(autoincrement())
  presupuestoId Int
  presupuesto   Presupuesto @relation(fields: [presupuestoId], references: [id])

  servicioId Int?
  servicio   Servicio? @relation(fields: [servicioId], references: [id])

  descripcion    String
  cantidad       Int
  precioUnitario Float
  totalLinea     Float

  createdAt DateTime @default(now())
}

model Factura {
  id          Int       @id @default(autoincrement())
  workspaceId Int
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  numero      String    
  clienteId   Int
  cliente     Cliente   @relation(fields: [clienteId], references: [id])

  fecha  DateTime @default(now())
  estado String   @default("borrador")

  // ðŸ”½ ADICIONA ESTES CAMPOS
  subtotal      Float @default(0)
  ivaPorcentaje Float @default(21)
  ivaImporte    Float @default(0)

  total  Float          @default(0)
  notas  String?
  lineas FacturaLinea[]

  createdAt DateTime @default(now())
  @@unique([workspaceId, numero])
}

model FacturaLinea {
  id             Int       @id @default(autoincrement())
  facturaId      Int
  factura        Factura   @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  servicioId     Int?
  servicio       Servicio? @relation(fields: [servicioId], references: [id])
  descripcion    String
  cantidad       Int       @default(1)
  precioUnitario Float
  totalLinea     Float
}

model EmpresaConfig {
  id          Int       @id @default(autoincrement())
  workspaceId Int       @unique
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  

  nombre    String
  nif       String?
  direccion String?
  cp        String?
  ciudad    String?
  provincia String?
  telefono  String?
  email     String?
  web       String?
  iban      String?
  logoPath  String?
  idioma String @default("es") // "es" ou "ca"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}




